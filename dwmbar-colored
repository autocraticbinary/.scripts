#!/bin/sh
# colors
#source ~/.local/bin/statusbar/themes/sweetmars
#source ~/.scripts/themes/dracula
#source ~/.local/bin/statusbar/themes/sweetdracula
#source ~/.scripts/themes/tomorrow-night
#source ~/.local/bin/statusbar/themes/tomorrow-dark
#source ~/.local/bin/statusbar/themes/tomorrow
source ~/.scripts/themes/gruvbox
#source ~/.scripts/themes/doom


interval=0

# Battery :
bat(){
	for battery in /sys/class/power_supply/BAT?*; do
		# If non-first battery, print a space separator.
		[ -n "${capacity+x}" ] && printf " "
		# Sets up the status and capacity
		case "$(cat "$battery/status" 2>&1)" in
			"Full") status="ïƒ§ " ;;
			"Discharging") status="ï‰€ " ;;
			"Charging") status="ï‡¦ " ;;
			"Not charging") status="ï— " ;;
			"Unknown") status="ï± " ;;
			*) exit 1 ;;
		esac
		capacity="$(cat "$battery/capacity" 2>&1)"
		# Will make a warn variable if discharging and low
		[ "$status" = "ï‰ƒ " ] && [ "$capacity" -le 25 ] && warn="ï„ª "
		# Prints the info
		printf "%s%s%d%%" "^c$orange^î‚²^c$black^^b$orange^ $status" "^c$black^^b$orange^ $warn" "$capacity"; unset warn
	done && printf " \\n"
}

# Date && clock :
dat(){
	date="$(date +"%a %d %b %H:%M"| sed 's/  / /g')"
	#echo -e "ï³ $date"
	echo -e "^c$blue^î‚²^c$black^^b$blue^ ï³  $date "
	
}

# Cpu Temp :
tmp(){
	ctmp=$(sensors | awk '/Core 0/ {print$3}' | sed 's/+//')
	echo -e "^c$red^î‚²^c$black^^b$red^ ï‹ˆ $ctmp "
}

# Cpu Usage :
cpu(){
	read cpu a b c previdle rest < /proc/stat
	prevtotal=$((a+b+c+previdle))
	sleep 0.5
	read cpu a b c idle rest < /proc/stat
	total=$((a+b+c+idle))
	cpu=$((100*( (total-prevtotal) - (idle-previdle) ) / (total-prevtotal) ))
	#echo -e "ï‰¬ $cpu%"
	echo -e "^c$cyan^î‚²^c$black^^b$cyan^ ï‹› $cpu% " 
}

# Keybord Layout :
key(){
	kb="$(xkb-switch)" || exit 1
	#echo "ï„œ $kb"
	echo -e "^c$green^î‚²^b$green^^c$black^^b$green^ ï„œ  $kb "
	
}

# Screen Light :
lit(){
	#lit="$(xbacklight | sed 's/\..*//g')"
	#echo "ï‚ $lit%"
	lit="$(brightnessctl | grep -oP '[^()]+%')"
	#echo "ï‚ $lit"
	echo -e "^c$yellow^î‚²^b$yellow^^c$black^^b$yellow^ ï‚  $lit "		
}

# Memory :
mem(){
	mem="$(free -h | awk '/^Mem/ { print $3 }' | sed s/i//g)"
	echo -e "^c$magenta^î‚²^b$magenta^^c$black^^b$magenta^ ï”¸ $mem "
}

# Volume :
vol(){
	[ $(pamixer --get-mute) = true ] && echo ïš© && exit

	vol="$(pamixer --get-volume)"

	if [ "$vol" -gt "70" ]; then
		icon="ï€¨ "
	elif [ "$vol" -gt "30" ]; then
		icon="ï€§ "
	elif [ "$vol" -gt "0" ]; then
		icon="ï€¦ " 
	else
		echo "ïš©" && exit
	fi
	echo "^c$magenta^î‚²^b$magenta^^c$black^^b$magenta^ $icon $vol% "
}

volm(){
  vol="$(wpctl get-volume @DEFAULT_AUDIO_SINK@)"

  # If muted, print ğŸ”‡ and exit.
  [ "$vol" != "${vol%\[MUTED\]}" ] && echo ğŸ”‡ && exit

  vol="${vol#Volume: }"

  split() {
	  # For ommiting the . without calling and external program.
	  IFS=$2
	  set -- $1
	  printf '%s' "$@"
  }

  vol="$(printf "%.0f" "$(split "$vol" ".")")"

  if [ "$vol" -gt "70" ]; then
		icon="ï€¨ "
	elif [ "$vol" -gt "30" ]; then
		icon="ï€§ "
	elif [ "$vol" -gt "0" ]; then
		icon="ï€¦ " 
	else
		echo "ïš©" && exit
	fi

  echo "^c$magenta^î‚²^b$magenta^^c$black^^b$magenta^ $icon $vol% "
}

net() {
	connected=$(cat /sys/class/net/e*/operstate 2>/dev/null)
	if [[ "$connected" =~ "up" ]]; then
		printf "^c$green^î‚²^b$green^^c$black^ ï›¿ %s"
	elif [[ "$connected" =~ "down" ]]; then
		check_wifi=$(cat /sys/class/net/wl*/operstate 2>/dev/null)
		if [[ "$check_wifi" =~ "up" ]]; then
			printf "^c$green^î‚²^b$green^^c$black^ ï‡«  %s"
		elif [[ "$check_wifi" =~ "down" ]]; then
			printf "^c$green^î‚²^b$green^^c$black^ ó°–ª  %s"
		fi
	fi
}

# Network traffic
nettrf(){
	
	update() {
		sum=0
		for arg; do
			read -r i < "$arg"
			sum=$(( sum + i ))
		done
		cache=${XDG_CACHE_HOME:-$HOME/.cache}/${1##*/}
		[ -f "$cache" ] && read -r old < "$cache" || old=0
		printf %d\\n "$sum" > "$cache"
		printf %d\\n $(( sum - old ))
	}

	rx=$(update /sys/class/net/[ew]*/statistics/rx_bytes)
	tx=$(update /sys/class/net/[ew]*/statistics/tx_bytes)

	printf "^c$magenta^î‚²^b$magenta^^c$black^ï„ƒ ^c$black^^b$magenta^ %4sB ^b$magenta^^c$black^ ï„‚^c$black^^b$magenta^ %4sB \\n" $(numfmt --to=iec $rx) $(numfmt --to=iec $tx)	
}

# Updates
pkg_updates() {
	# updates=$(xbps-install -un | wc -l) # void
  	# updates=$(eix --installed --upgrade | tail -1 | awk '{ print $2 }')
	# updates=$(pacman -Qu | grep -Fcv "[ignored]" | sed "s/^//;s/^0$//g")   # arch , needs pacman contrib
	# updates=$(aptitude search '~U' | wc -l)  # apt (ubuntu,debian etc)

	if [ "$updates" == "0" ]; then
		printf "^c$green^î‚²^b$green^^c$black^ ï†‡ ^c$green^^b$black^Fully Updated^d^"
	else
		printf "^c$green^î‚²^b$green^^c$black^ ï†‡ $updates " "^c$green^^b$black^updates ^d^"
	fi
}

updates() {
	updates=$(checkupdates 2> /dev/null | wc -l )
	printf "^c$green^î‚²^b$green^^c$black^ ï†‡ $updates " "^c$green^"
}

utime() {
	upt=$(uptime | awk '{print $3,$4}' | sed 's/,//')
	printf "^c$magenta^î‚²^b$magenta^^c$black^ ó°”Ÿ $upt " "^c$magenta^"
}

blank() {
	spc=" ó°£‡ "
	echo "^c$orange^^b$orange^^c$black^$spc^b$black^^b$orange^"
}
while true; do
 [ $interval = 0 ] || [ $(($interval % 3600)) = 0 ] && updates=$(pkg_updates)
  interval=$((interval + 1))
  space=" "
  range="|"
  
  #xsetroot -name "$updates$(nettrf)$(tmp)$(cpu)$(mem)$(vol)$(lit)$(bat)$(key)$(dat)$(net)"
  # xsetroot -name "$(cpu)$(mem)$(vol)$(lit)$(bat)$(key)$(dat)$(net)"
  # xsetroot -name "$updates$(cpu)$(mem)$(lit)$(bat)$(dat)$(net)"
  xsetroot -name "$(blank)$(updates)$(cpu)$(tmp)$(utime)$(lit)$(volm)$(bat)$(net)$(dat)"
  sleep 0.2
done &
